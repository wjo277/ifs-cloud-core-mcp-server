<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IFS Cloud Explorer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;

      function SearchApp() {
        const [query, setQuery] = useState("");
        const [results, setResults] = useState([]);
        const [suggestions, setSuggestions] = useState([]);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const [selectedSuggestion, setSelectedSuggestion] = useState(-1);
        const [loading, setLoading] = useState(false);
        const [stats, setStats] = useState(null);
        const [filters, setFilters] = useState({
          file_type: "",
          module: "",
          logical_unit: "",
          limit: 20,
        });

        // Load initial stats
        useEffect(() => {
          fetch("/api/stats")
            .then((response) => response.json())
            .then((data) => setStats(data))
            .catch((error) => console.error("Error loading stats:", error));
        }, []);

        // Debounced suggestions
        useEffect(() => {
          if (query.length < 2) {
            setSuggestions([]);
            setShowSuggestions(false);
            return;
          }

          const timeoutId = setTimeout(() => {
            fetch("/suggestions", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query, limit: 10 }),
            })
              .then((response) => response.json())
              .then((data) => {
                setSuggestions(data.suggestions || []);
                setShowSuggestions(true);
              })
              .catch((error) =>
                console.error("Error getting suggestions:", error)
              );
          }, 300);

          return () => clearTimeout(timeoutId);
        }, [query]);

        const search = useCallback(async () => {
          if (!query.trim()) return;

          setLoading(true);
          setShowSuggestions(false);

          try {
            const response = await fetch("/search", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                query,
                limit: parseInt(filters.limit) || 20,
                file_type: filters.file_type || null,
                module: filters.module || null,
                logical_unit: filters.logical_unit || null,
              }),
            });

            const data = await response.json();
            setResults(data.results || []);
          } catch (error) {
            console.error("Search error:", error);
            setResults([]);
          } finally {
            setLoading(false);
          }
        }, [query, filters]);

        const handleKeyDown = (e) => {
          if (e.key === "Enter") {
            search();
          } else if (e.key === "ArrowDown") {
            e.preventDefault();
            setSelectedSuggestion((prev) =>
              prev < suggestions.length - 1 ? prev + 1 : prev
            );
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            setSelectedSuggestion((prev) => (prev > 0 ? prev - 1 : -1));
          } else if (e.key === "Escape") {
            setShowSuggestions(false);
            setSelectedSuggestion(-1);
          }
        };

        const selectSuggestion = (suggestion) => {
          setQuery(suggestion.text);
          setShowSuggestions(false);
          setSelectedSuggestion(-1);
        };

        const handleFilterChange = (field, value) => {
          setFilters((prev) => ({ ...prev, [field]: value }));
        };

        const getSuggestionTypeClass = (type) => {
          const classes = {
            entity: "bg-blue-100 text-blue-800",
            file: "bg-green-100 text-green-800",
            module: "bg-purple-100 text-purple-800",
            frontend: "bg-orange-100 text-orange-800",
          };
          return classes[type] || "bg-gray-100 text-gray-800";
        };

        const highlightText = (text, query) => {
          if (!query) return text;
          const regex = new RegExp(`(${query})`, "gi");
          const parts = text.split(regex);
          return parts.map((part, index) =>
            regex.test(part) ? (
              <mark key={index} className="bg-yellow-200">
                {part}
              </mark>
            ) : (
              part
            )
          );
        };

        return (
          <div className="container mx-auto px-4 py-8">
            {/* Header */}
            <div className="mb-8">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                <i className="fas fa-search text-blue-600"></i>
                IFS Cloud Explorer
              </h1>
              <p className="text-gray-600">
                Intelligent search for IFS Cloud codebases with frontend element
                discovery
              </p>
            </div>

            {/* Search Section */}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <div className="relative">
                {/* Search Input */}
                <div className="relative">
                  <input
                    type="text"
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                    onKeyDown={handleKeyDown}
                    onFocus={() =>
                      query.length >= 2 && setShowSuggestions(true)
                    }
                    placeholder="Search entities, functions, pages, iconsets, trees, navigators..."
                    className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                  />
                  <i className="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                  <button
                    onClick={search}
                    disabled={loading}
                    className="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 disabled:opacity-50"
                  >
                    {loading ? "Searching..." : "Search"}
                  </button>
                </div>

                {/* Type-ahead Suggestions */}
                {showSuggestions && suggestions.length > 0 && (
                  <div className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-64 overflow-y-auto shadow-lg">
                    {suggestions.map((suggestion, index) => (
                      <div
                        key={index}
                        onClick={() => selectSuggestion(suggestion)}
                        className={`px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 ${
                          selectedSuggestion === index ? "bg-blue-50" : ""
                        }`}
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <span className="font-medium">
                              {suggestion.text}
                            </span>
                            <span className="text-sm text-gray-500 ml-2">
                              {suggestion.context}
                            </span>
                          </div>
                          <span
                            className={`px-2 py-1 rounded text-xs font-medium ${getSuggestionTypeClass(
                              suggestion.type
                            )}`}
                          >
                            {suggestion.type}
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Filters */}
              <div className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <select
                  value={filters.file_type}
                  onChange={(e) =>
                    handleFilterChange("file_type", e.target.value)
                  }
                  className="border border-gray-300 rounded px-3 py-2"
                >
                  <option value="">All File Types</option>
                  <option value=".entity">Entity</option>
                  <option value=".client">Client</option>
                  <option value=".projection">Projection</option>
                  <option value=".fragment">Fragment</option>
                  <option value=".plsql">PL/SQL</option>
                  <option value=".views">Views</option>
                  <option value=".storage">Storage</option>
                </select>

                <input
                  value={filters.module}
                  onChange={(e) => handleFilterChange("module", e.target.value)}
                  placeholder="Module filter..."
                  className="border border-gray-300 rounded px-3 py-2"
                />
                <input
                  value={filters.logical_unit}
                  onChange={(e) =>
                    handleFilterChange("logical_unit", e.target.value)
                  }
                  placeholder="Logical Unit filter..."
                  className="border border-gray-300 rounded px-3 py-2"
                />
                <input
                  value={filters.limit}
                  onChange={(e) => handleFilterChange("limit", e.target.value)}
                  type="number"
                  placeholder="Result limit..."
                  className="border border-gray-300 rounded px-3 py-2"
                />
              </div>
            </div>

            {/* Stats */}
            {stats && (
              <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 className="text-xl font-semibold mb-4">Index Statistics</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-blue-600">
                      {stats.total_files || 0}
                    </div>
                    <div className="text-gray-600">Total Files</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-green-600">
                      {stats.total_entities || 0}
                    </div>
                    <div className="text-gray-600">Total Entities</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-purple-600">
                      {(stats.supported_extensions || []).length}
                    </div>
                    <div className="text-gray-600">Supported Types</div>
                  </div>
                </div>
              </div>
            )}

            {/* Results */}
            {results.length > 0 && (
              <div className="bg-white rounded-lg shadow-md p-6">
                <h2 className="text-xl font-semibold mb-4">
                  Search Results ({results.length})
                </h2>
                <div className="space-y-4">
                  {results.map((result, index) => (
                    <div
                      key={`${result.path}-${result.hash}`}
                      className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                          <h3 className="font-semibold text-lg text-blue-600 hover:text-blue-800">
                            {highlightText(result.name, query)}
                          </h3>
                          <p className="text-sm text-gray-500">{result.path}</p>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-medium">
                            {result.type}
                          </span>
                          <span className="text-sm text-gray-500">
                            Score: {result.score?.toFixed(2)}
                          </span>
                        </div>
                      </div>

                      <p className="text-gray-700 mb-3">
                        {highlightText(result.content_preview, query)}
                      </p>

                      <div className="flex flex-wrap gap-2 mb-2">
                        {result.tags?.map((tag, tagIndex) => (
                          <span
                            key={`${result.path}-${result.hash}-tag-${tagIndex}`}
                            className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs"
                          >
                            {tag}
                          </span>
                        ))}
                      </div>

                      <div className="text-sm text-gray-500 grid grid-cols-2 md:grid-cols-4 gap-2">
                        <span>Lines: {result.line_count}</span>
                        <span>
                          Complexity: {result.complexity_score?.toFixed(2)}
                        </span>
                        {result.module && <span>Module: {result.module}</span>}
                        {result.logical_unit && (
                          <span>LU: {result.logical_unit}</span>
                        )}
                      </div>

                      {(result.pages?.length > 0 ||
                        result.iconsets?.length > 0 ||
                        result.trees?.length > 0 ||
                        result.navigators?.length > 0) && (
                        <div className="mt-3 pt-3 border-t border-gray-200">
                          <h4 className="text-sm font-medium text-gray-700 mb-2">
                            Frontend Elements:
                          </h4>
                          <div className="flex flex-wrap gap-2">
                            {result.pages?.map((page, pageIndex) => (
                              <span
                                key={`${result.path}-${result.hash}-page-${pageIndex}`}
                                className="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs"
                              >
                                ðŸ“„ {page}
                              </span>
                            ))}
                            {result.iconsets?.map((iconset, iconIndex) => (
                              <span
                                key={`${result.path}-${result.hash}-iconset-${iconIndex}`}
                                className="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs"
                              >
                                ðŸŽ¨ {iconset}
                              </span>
                            ))}
                            {result.trees?.map((tree, treeIndex) => (
                              <span
                                key={`${result.path}-${result.hash}-tree-${treeIndex}`}
                                className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs"
                              >
                                ðŸŒ³ {tree}
                              </span>
                            ))}
                            {result.navigators?.map((nav, navIndex) => (
                              <span
                                key={`${result.path}-${result.hash}-nav-${navIndex}`}
                                className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs"
                              >
                                ðŸ§­ {nav}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {loading && (
              <div className="text-center py-8">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p className="mt-2 text-gray-600">Searching...</p>
              </div>
            )}
          </div>
        );
      }

      // Render the app
      ReactDOM.render(<SearchApp />, document.getElementById("root"));
    </script>
  </body>
</html>
